<?php
/**
 * @file
 * Handles the installation process and enabling of the P2 modules.
 */

/**
 * Implements hook_enable().
 *
 * Inserts ratings and serendipity extra fields on Ting Objects.
 *
 * This installer sets up a default installation for the whole P2 package
 * If you install each P2 module individually we assume you don't want the
 * default installation settings.
 *
 * Load each field group for each display mode,
 * and insert rating and serendipity fields in the correct field groups.
 */
function ding_p2_installer_modules_enabled() {
  // Default:
  $view_mode = 'default';
  $group = field_group_load_field_group('group_ting_object_right_column', 'ting_object', 'ting_object', $view_mode);
  $group->children[] = 'ding_serendipity_info';
  $group->children[] = 'ding_entity_rating_action';
  $group->children[] = 'ding_entity_rating_result';
  field_group_group_save($group);

  // Set row weights for ting objects:
  ding_p2_installer_extra_field_update_weight('ding_serendipity_info', 'ting_object', 'ting_object', $view_mode, 6);
  ding_p2_installer_field_update_weight('ding_entity_rating_action', 'ting_object', 'ting_object', $view_mode, 7);
  ding_p2_installer_field_update_weight('ding_entity_rating_result', 'ting_object', 'ting_object', $view_mode, 8);

  ding_p2_installer_field_update_weight('ting_series', 'ting_object', 'ting_object', $view_mode, 9);
  ding_p2_installer_field_update_weight('ting_subjects', 'ting_object', 'ting_object', $view_mode, 10);
  ding_p2_installer_field_update_weight('ding_entity_buttons', 'ting_object', 'ting_object', $view_mode, 11);

  // Teaser:
  $view_mode = 'teaser';
  $group = field_group_load_field_group('group_ting_object_teaser_right', 'ting_object', 'ting_object', $view_mode);
  $group->children[] = 'ding_serendipity_info';
  $group->children[] = 'ding_entity_rating_action';
  $group->children[] = 'ding_entity_rating_result';
  field_group_group_save($group);

  ding_p2_installer_extra_field_update_weight('ding_serendipity_info', 'ting_object', 'ting_object', $view_mode, 7);
  ding_p2_installer_field_update_weight('ding_entity_rating_action', 'ting_object', 'ting_object', $view_mode, 8);
  ding_p2_installer_field_update_weight('ding_entity_rating_result', 'ting_object', 'ting_object', $view_mode, 9);

  // Search result:
  $view_mode = 'search_result';
  $group = field_group_load_field_group('group_ting_right_col_search', 'ting_object', 'ting_object', $view_mode);
  $group->children[] = 'ding_entity_rating_action';
  $group->children[] = 'ding_entity_rating_result';
  field_group_group_save($group);

  ding_p2_installer_extra_field_update_weight('ding_serendipity_info', 'ting_object', 'ting_object', $view_mode, 0, FALSE);
  ding_p2_installer_field_update_weight('ding_entity_rating_action', 'ting_object', 'ting_object', $view_mode, 20);
  ding_p2_installer_field_update_weight('ding_entity_rating_result', 'ting_object', 'ting_object', $view_mode, 21);

  // Compact:
  $view_mode = 'compact';
  ding_p2_installer_field_update_weight('ting_cover', 'ting_object', 'ting_object', $view_mode, 0);
  ding_p2_installer_field_update_weight('ting_title', 'ting_object', 'ting_object', $view_mode, 1);
  ding_p2_installer_field_update_weight('ding_entity_rating_action', 'ting_object', 'ting_object', $view_mode, 2);
  ding_p2_installer_field_update_weight('ding_entity_rating_result', 'ting_object', 'ting_object', $view_mode, 3);
  ding_p2_installer_extra_field_update_weight('ding_serendipity_info', 'ting_object', 'ting_object', $view_mode, 4, FALSE);

  // Set row weights for taxonomy terms:
  $view_mode = 'teaser';
  ding_p2_installer_extra_field_update_weight('description', 'taxonomy_term', 'ding_content_tags', $view_mode, 0, FALSE);

  // Set default values for ding_user_complete:
  $defaults = array(
    'ding_entity_rating' => 'ding_entity_rating',
    'ding_interests' => 'ding_interests',
    'ding_list_created_list' => 'ding_list_created_list',
    'ding_list_following_author' => 'ding_list_following_author',
    'ding_list_following_search' => 'ding_list_following_search',
  );
  variable_set('ding_user_complete_callbacks', $defaults);

  // Set ding_frontpage to use serendipity:
  variable_set('ding_frontpage_promoter', 'serendipity');

  // Activate user consent by default:
  variable_set('user_consent_activate', TRUE);

  // Clear the field group cache after updates.
  cache_clear_all('field_groups', 'cache_field');
}

/**
 * Helper function to update row weights of extra fields.
 */
function ding_p2_installer_extra_field_update_weight($field_name, $entity_type, $bundle, $view_mode, $weight = 0, $visible = TRUE) {
  $settings = field_bundle_settings($entity_type, $bundle);

  // Set the weight and visibility of the field for this view mode.
  $settings['extra_fields']['display'][$field_name][$view_mode] = array(
    'weight' => $weight,
    'visible' => $visible,
  );

  field_bundle_settings($entity_type, $bundle, $settings);
}

/**
 * Helper function to update row weights of normal fields.
 */
function ding_p2_installer_field_update_weight($field_name, $entity_type, $bundle, $view_mode, $weight = 0) {
  $instance = field_read_instance($entity_type, $field_name, $bundle);
  $instance['display'][$view_mode]['weight'] = $weight;
  field_update_instance($instance);
}

/**
 * Implements hook_ctools_plugin_api().
 */
function ding_p2_installer_ctools_plugin_api($module = NULL, $api = NULL) {
  if ($module == "page_manager" && $api == "pages_default") {
    return array("version" => "1");
  }
}

/**
 * Implements hook_permission().
 *
 * Set up the two main permissions for P2.
 */
function ding_p2_installer_permission() {
  return array(
    'use personalisation' => array(
      'title' => t('Use personalisation'),
    ),
    'administer personalisation' => array(
      'title' => t('Administer personalisation'),
    ),
  );
}
