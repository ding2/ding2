<?php

/**
 * @file
 * Provide cover images from the DDB Cover Service API.
 */

/**
 * Implements hook_xautoload().
 */
function ting_covers_rest_xautoload($adapter) {
  $adapter->absolute()->addPsr4('TingCoversRestService\\', drupal_get_path('module', 'ting_covers_rest') . '/src');
  $adapter->absolute()->addPsr4('OpenAPI\\Client\\', drupal_get_path('module', 'ting_covers_rest') . '/lib');
}

/**
 * Implements hook_menu().
 */
function ting_covers_rest_menu() {
  $items = array();

  $items['admin/config/ting/covers/rest'] = array(
    'title' => 'DDB Cover Service API',
    'description' => 'Configure integration with the DDB Cover Service API.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ting_covers_rest_admin_settings_form'),
    'access arguments' => array('administer site configuration'),
    'file' => 'ting_covers_rest.admin.inc',
    'type' => MENU_LOCAL_TASK,
  );

  return $items;
}

/**
 * Implements hook_ting_covers().
 *
 * Fetch covers from DDB Cover Service API service.
 *
 * @param \TingEntity[] $entities
 *
 * @return array
 *    Array of image URLs keyed by TingEntity ID.
 */
function ting_covers_rest_ting_covers($entities) {
  $service = ting_covers_rest_service();
  $ids = array_keys($entities);

  $covers = $service->getCovers(
    variable_get('ting_covers_rest_type', \OpenAPI\Client\Model\Type::PID),
    $ids,
    variable_get('ting_covers_rest_format'),
    variable_get('ting_covers_rest_size')
  );

  // Return all image information.
  return $service->getCoverImages($covers);
}

/**
 * Instantiate TingCoversRestService from settings.
 *
 * @return \TingCoversRestService
 *    The high-level TingCovers REST API client.
 */
function ting_covers_rest_service() {
  // Initialize OpenAPI settings from admin form in Drupal.
  return new TingCoversRestService(
    variable_get('ting_covers_rest_oauth2_token', NULL),
    variable_get('ting_covers_rest_url', NULL),
    variable_get('ting_covers_rest_enable_debugging', FALSE)
  );
}
