<?php
/**
 * @file
 * Include basic hooks for the module functionality.
 */

/**
 * Implements hook_menu().
 */
function ding_webtrekk_menu() {
  $items = [];
  $items['admin/config/ding/webtrekk'] = [
    'title' => 'Webtrekk',
    'description' => 'Settings for the Webtrekk analytics tool.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ding_webtrekk_admin_settings_form'),
    'access arguments' => array('administer site configuration'),
    'file' => 'ding_webtrekk.admin.inc',
  ];
  
  return $items;
}

/**
 * Implements hook_page_alter().
 */
function ding_webtrekk_page_alter(&$page) {
  $script = 'window._ti = window._ti || {};';

  $title = drupal_get_title();
  if ($title) {
    $script .= "window._ti['pageTitle'] = '$title';";
  }

  $page['page_bottom']['webtrekk']['#attached']['js'] = [
    [
      'data' => $script,
      'type' => 'inline',
    ],
    [
      'data' => drupal_get_path('module', 'ding_webtrekk') . '/js/tiLoader.min.js',
      'type' => 'file',
      'scope' => 'footer',
    ],
    [
      'data' => [
        'ding_webtrekk' => [
          'webtrekk_ti_domain' => variable_get('webtrekk_ti_domain', ''),
          'webtrekk_ti_id' => variable_get('webtrekk_ti_id', ''),
        ]
      ],
      'type' => 'setting',
    ],
  ];
}

/**
 * Implements hook_panels_pane_content_alter().
 */
function ding_webtrekk_panels_pane_content_alter($content, $pane, $args, $contexts) {
  if ($pane->type == 'search_result' && $pane->configuration['type'] == 'ting_search') {
    if ($search_result = drupal_static('ting_search_results', FALSE)) {
      $script = 'window._ti = window._ti || {};';
      // Pass page title to the script.
      if (!empty($content->original_title)) {
        $script .= "\nwindow._ti['pageTitle'] = '$content->original_title';";
      }

      // Pass search options to the script.
      $search_key = $search_result->search_key;
      $count = $search_result->numTotalObjects;
      $script .= "\nwindow._ti['OSS'] = '$search_key';\nwindow._ti['OSSr'] = '$count';";

      drupal_add_js($script, array(
        'type' => 'inline',
      ));
    }
  }
}

/**
 * Implements hook_views_post_execute().
 */
function ding_webtrekk_views_post_execute(&$view) {
  if ($view->name == 'ding_multiple_search') {
    $script = 'window._ti = window._ti || {};';

    $search_key = array_shift($view->args);
    $script .= "\nwindow._ti['internalSearch'] = '$search_key'";

    $count = $view->total_rows;
    $script .= "\nwindow._ti['numberSearchResults'] = '$count';";

    if (!empty($view->human_name)) {
      $script .= "\nwindow._ti['pageTitle'] = '$view->human_name';";
    }

    drupal_add_js($script, array(
      'type' => 'inline',
    ));
  }
}
