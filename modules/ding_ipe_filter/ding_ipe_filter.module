<?php
/**
 * @file
 * Provide IPE Filter menu functionality.
 */

include_once 'ding_ipe_filter.features.inc';


/**
 * Implements hook_menu().
 */
function ding_ipe_filter_menu() {
  $items['admin/config/user-interface/ipe-filter'] = array(
    'title' => 'IPE pane filter settings',
    'description' => 'Configure IPE filter default options.',
    'weight' => 1,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ding_ipe_filter_default_settings_form'),
    'access arguments' => array('access administration pages'),
    'file' => 'ding_ipe_filter.admin.inc',
  );
  $items['admin/config/user-interface/ipe-filter/default'] = array(
    'title' => 'Settings',
    'description' => 'Default settings for IPE filter',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => 1,
  );
  $items['admin/config/user-interface/ipe-filter/panes'] = array(
    'title' => 'IPE pane filter',
    'description' => 'Choose what content should be displayed on the add content modal page.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ding_ipe_filter_admin_panes_form'),
    'access arguments' => array('access administration pages'),
    'file' => 'ding_ipe_filter.admin.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 2,
  );
  return $items;
}

/**
 * Implements hook_theme().
 */
function ding_ipe_filter_theme() {
  return array(
    'ding_ipe_filter_table' => array(
      'render element' => 'form',
    ),
  );
}

/**
 * Implements theme_hook().
 */
function theme_ding_ipe_filter_table($variables) {
  $form = $variables['form'];
  $header = $form['#header'];

  $content = array(
    'header' => $header,
    'rows' => array(),
  );
  foreach (element_children($form) as $row_index) {
    if (isset($form[$row_index]['title'])) {
      $content['rows'][] = array(
        drupal_render($form[$row_index]['title']),
        drupal_render($form[$row_index]['value']),
      );
    }
    else {
      $content['rows'][] = array(array(
        'data' => drupal_render($form[$row_index]),
          'colspan' => 2,
          'header' => TRUE,
        )
      );
    }
  }
  $output = theme('table', $content);
  $output .= drupal_render_children($form);
  return $output;
}

/**
 * Implements hook_theme_registry_alter().
 */
function ding_ipe_filter_theme_registry_alter(&$registry) {
  global $user;
  $ipe_roles = variable_get('ding_ipe_filter_roles', array());

  if (!empty($user->roles)) {
    $role_names = array_values($user->roles);
    $user_roles = array_combine($role_names, $role_names);
    $roles = array_intersect(array_keys($user_roles), $ipe_roles);
  }
  if (!empty($roles)) {
    $registry['panels_ipe_add_pane_button']['function'] = '_ding_ipe_filter_add_pane_buttons';
  }
}

/**
 * Add pane buttons on IPE filter menu based on settings and enabled modules.
 *
 * @param array $variables
 *   Theme registry variables.
 *
 * @return string
 *   Rendered IPE filter menu.
 */
function _ding_ipe_filter_add_pane_buttons($variables = array()) {
  ctools_include('content');
  $content_types = ctools_content_get_available_types();
  $panel_editor = new panels_renderer_editor();
  $categories = $panel_editor->get_categories($content_types);

  $assets_loaded = &drupal_static('ipe_assets_loaded', FALSE);
  $settings = variable_get('ding_ipe_filter_table', array());
  $region_id  = $variables['region_id'];
  $renderer = $variables['renderer'];

  $buttons = array();
  $menu_width = 300;
  $attributes = array(
    'class' => 'ctools-use-modal ding-ipe-menu-item',
    'style' => 'width: ' . $menu_width . 'px; height: auto;',
  );

  foreach ($settings as $subtype_name => $setting) {
    $enabled_category = isset($categories[$setting['category']]['content'][$setting['delta']]);
    if ($setting['value'] == 1 && $enabled_category) {
      $buttons[] = l($setting['delta'], $renderer->get_url('add-pane', $region_id, $setting['type'], $setting['subtype']), array('attributes' => $attributes));
    }
  }

  $buttons = '<div id="ipe-add-' . $region_id . '" class="panels-ipe-newblock ipe-popup">' . theme('item_list', array('items' => $buttons)) . '</div>';

  if (!$assets_loaded) {
    $path = drupal_get_path('module', 'ding_ipe_filter');
    drupal_add_js($path . '/js/ipe.js', 'file');
    drupal_add_css($path . '/css/ipe.css', 'file');
    $assets_loaded = TRUE;
  }
  return '<div class="panels-ipe-newblock panels-ipe-on">' . l(t('Add'), NULL, array('attributes' => array('class' => 'ipe-trigger', 'target_region' => $region_id))) . '</div>' . $buttons;
}
