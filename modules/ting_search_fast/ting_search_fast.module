<?php

use Ting\TingObjectCollectionInterface;
use Ting\TingObjectInterface;

function ting_search_fast_theme($existing, $type, $theme, $path) {
  return array(
    'ting_search_fast_item' => array(
      'variables' => array(
        'title' => NULL,
        'creators' => NULL,
        'abstract' => NULL,
        'cover' => NULL,
        'series' => NULL,
        'availability' => NULL,
      ),
      'template' => 'ting-search-fast-item',
      'path' => $path . '/templates',
    ),
  );
}

/**
 * Implements hook_theme_registry_alter().
 */
function ting_search_fast_theme_registry_alter(&$theme_registry) {
  $theme_registry['ting_search_collection_snippet']['function'] = 'ting_search_fast_ting_search_collection_snippet';
}

function ting_search_fast_ting_search_collection_snippet(array $variables) {
  /* @var \Ting\TingObjectCollectionInterface $collection */
  $collection = $variables['collection'];
  $object = $collection->getPrimaryObject();

  // The covers module does not use the search abstraction layer so instead we
  // create a dummy object with the required properties.
  $cover_object = new stdClass();
  $cover_object->id = $object->getId();
  $cover_object->title = $object->getShortTitle();
  $cover_object->creators = $object->getCreators();

  return [
    '#theme' => 'ting_search_fast_item',
    '#title' => theme('ting_title',
      [
        'collection' => $collection,
        'uri' => ting_ting_collection_uri($collection),
        'prefix_type' => TRUE,
      ]
    ),
    '#creators' => theme('ting_creators',
      [
        'object' => $object
      ]
    ),
    '#cover' => theme('ting_object_cover',
      [
        'elements' => [
          '#object' => $cover_object,
          '#image_style' => 'ding_list_medium',
          '#link' => ting_ting_collection_uri($collection)['path'],
        ],
      ]
    ),
    '#abstract' => theme('ting_abstract',
      [
        'object' => $object,
        'max_length' => 120
      ]
    ),
    '#series' => theme('ting_series',
      [
        'object' => $object
      ]
    ),
    '#availability' => theme('ding_availability_collection_labels',
      [
        'collection' => $collection,
      ]
    ),
    '#attached' => [
      'js' => [ drupal_get_path('module', 'ting_covers') . '/js/ting-covers.js' ]
    ]
  ];
}
